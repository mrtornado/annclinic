---
import { Image } from "astro:assets";

export interface Props {
  src: string | ImageMetadata;
  alt: string;
  width: number;
  height: number;
  class?: string;
  loading?: "eager" | "lazy";
  aspectRatio?: string;
  quality?: number;
  format?: "webp" | "avif" | "png" | "jpg";
  sizes?: string;
  priority?: boolean;
}

const {
  src,
  alt,
  width,
  height,
  class: className = "",
  loading = "lazy",
  aspectRatio,
  quality = 80,
  format = "webp",
  sizes,
  priority = false,
} = Astro.props;

// Calculate aspect ratio if not provided
const calculatedAspectRatio = aspectRatio || `${width}/${height}`;

// Set loading based on priority
const loadingStrategy = priority ? "eager" : loading;
---

<div
  class={`aspect-ratio-container ${className}`}
  style={`--aspect-ratio: ${(height / width) * 100}%`}
>
  <!-- Skeleton placeholder while loading -->
  <div class="image-skeleton absolute inset-0 rounded-inherit"></div>

  <!-- Optimized image -->
  <Image
    src={src}
    alt={alt}
    width={width}
    height={height}
    quality={quality}
    format={format}
    loading={loadingStrategy}
    decoding="async"
    sizes={sizes}
    class="opacity-0 transition-opacity duration-300"
    style={`aspect-ratio: ${calculatedAspectRatio}`}
    onload="this.style.opacity = '1'; this.previousElementSibling.style.display = 'none';"
  />
</div>

<style>
  .aspect-ratio-container {
    position: relative;
    width: 100%;
    overflow: hidden;
  }

  .aspect-ratio-container::before {
    content: "";
    display: block;
    padding-bottom: var(--aspect-ratio);
  }

  .aspect-ratio-container > :global(img) {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .image-skeleton {
    background: linear-gradient(
      90deg,
      rgba(243, 244, 246, 0.8) 25%,
      rgba(229, 231, 235, 0.8) 50%,
      rgba(243, 244, 246, 0.8) 75%
    );
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }

  @keyframes shimmer {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }
</style>
