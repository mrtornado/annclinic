---
import { getCollection } from "astro:content";
import ServiceLayout from "../../layouts/ServiceLayout.astro";
import ServiceHero from "../../components/services/ServiceHero.tsx";
import ServiceDetails from "../../components/services/ServiceDetails.tsx";
import { getImage } from "astro:assets";

// Importăm direct imaginile necesare
import chirurgieImg from "../../assets/images/servicii/chirurgie.webp";
import chirurgiePediatricaImg from "../../assets/images/servicii/CHIRURGIE-PEDIATRICA.webp";
import dermatologieImg from "../../assets/images/servicii/dermatologie.webp";
import ginecologieImg from "../../assets/images/servicii/ginecologie.webp";
import medicinaFamilieImg from "../../assets/images/servicii/fam-scaled.webp";
import medicinaInternaImg from "../../assets/images/servicii/medicina-interna.webp";
import medicinaMunciiImg from "../../assets/images/servicii/medicina-muncii.webp";
import nefrologieImg from "../../assets/images/servicii/nefrologie.webp";
import ortopedieImg from "../../assets/images/servicii/orto.webp";
import pediatrieImg from "../../assets/images/servicii/pediatrrie.webp";
import cardiologieImg from "../../assets/images/servicii/soon/cardiologie.webp";
import orlImg from "../../assets/images/servicii/soon/ORL.webp";
import oftalmologieImg from "../../assets/images/servicii/soon/oftamologie.webp";
import urologieImg from "../../assets/images/servicii/soon/UROLOGIE.webp";
import neurologieImg from "../../assets/images/servicii/medicina-interna.webp"; // Folosim o imagine temporară

// Creăm o mapare a imaginilor pentru servicii
const serviceImageMap: Record<string, any> = {
  "chirurgie-generala": chirurgieImg,
  "chirurgie-pediatrica": chirurgiePediatricaImg,
  dermatologie: dermatologieImg,
  ginecologie: ginecologieImg,
  "medicina-familie": medicinaFamilieImg,
  "medicina-interna": medicinaInternaImg,
  "medicina-muncii": medicinaMunciiImg,
  nefrologie: nefrologieImg,
  ortopedie: ortopedieImg,
  pediatrie: pediatrieImg,
  cardiologie: cardiologieImg,
  orl: orlImg,
  oftalmologie: oftalmologieImg,
  urologie: urologieImg,
  neurologie: neurologieImg,
  default: medicinaFamilieImg,
};

// Server-side rendering pentru dynamic routes
const { slug } = Astro.params;
const serviceSlug = Array.isArray(slug) ? slug.join("/") : slug || "";

// Găsim serviciul pe baza slug-ului
const services = await getCollection("services");
const service = services.find((s) => s.slug === serviceSlug);

// 404 dacă serviciul nu există
if (!service) {
  return new Response(null, {
    status: 404,
    statusText: "Serviciul nu a fost găsit"
  });
}
const serviceName = service.data.name;

// Optimizăm imaginile pentru servicii direct în pagina Astro
const optimizedServiceImages: Record<string, any> = {};

// Adăugăm loguri pentru debug
console.log("[...slug].astro - serviceSlug:", serviceSlug);
console.log(
  "[...slug].astro - serviceImageMap keys:",
  Object.keys(serviceImageMap)
);

// Întotdeauna optimizăm imaginea default pentru a evita erorile
const defaultImg = serviceImageMap.default;
console.log("[...slug].astro - defaultImg:", defaultImg);

const optimizedDefaultImg = await getImage({
  src: defaultImg,
  width: 400,
  height: 300,
  format: "webp",
  quality: 80,
});

console.log("[...slug].astro - optimizedDefaultImg:", optimizedDefaultImg);

// Adaugăm imaginea default în optimizedServiceImages
optimizedServiceImages.default = optimizedDefaultImg;
console.log(
  "[...slug].astro - optimizedServiceImages.default:",
  optimizedServiceImages.default
);

// Optimizăm imaginea pentru serviciul curent dacă există în serviceImageMap
if (serviceSlug in serviceImageMap) {
  const serviceImg = serviceImageMap[serviceSlug];
  console.log(
    "[...slug].astro - serviceImg pentru",
    serviceSlug,
    ":",
    serviceImg
  );

  const optimizedImg = await getImage({
    src: serviceImg,
    width: 800,
    height: 600,
    format: "webp",
    quality: 80,
  });

  console.log(
    "[...slug].astro - optimizedImg pentru",
    serviceSlug,
    ":",
    optimizedImg
  );
  optimizedServiceImages[serviceSlug] = optimizedImg;
  console.log(
    "[...slug].astro - optimizedServiceImages[",
    serviceSlug,
    "]:",
    optimizedServiceImages[serviceSlug]
  );
}
---

<ServiceLayout service={service}>
  <!-- Service Hero Section -->
  <ServiceHero service={service} client:load />

  <!-- Service Details Section with optimized images -->
  <ServiceDetails
    service={service}
    serviceImages={optimizedServiceImages}
    client:load
  />
</ServiceLayout>

<!-- Removed optimization script since we're using direct imports -->
